name: "ci"
on:
  pull_request:
  push:
    branches:
      - master
      - dev
jobs:
  compile-lib:
    name: Build the library and upload it to artifacts
    runs-on: ubuntu-18.04
    strategy:
      fail-fast: false
      matrix:
        os:
          - name: alpine
            version: 3.13
          - name: ubuntu
            version: 18.04
        compiler: [ gcc, clang ]
        compiler_version: [ 10 ]
    steps:
      - uses: actions/checkout@v2
      - name: Download Base Library
        uses: dawidd6/action-download-artifact@v2
        with:
          # Optional, GitHub token, a Personal Access Token with `public_repo` scope if needed
          # Required, if artifact is from a different repo
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # Required, workflow file name or ID
          workflow: ci.yml
          # Optional, will use the branch
          branch: dev
          # Optional, uploaded artifact name,
          # will download all artifacts if not specified
          # and extract them in respective subdirectories
          # https://github.com/actions/download-artifact#download-all-artifacts
          name: xalwart.base-${{ matrix.os.name }}-${{ matrix.compiler }}-${{ matrix.compiler_version }}
          # Optional, defaults to current repo
          repo: YuriyLisovskiy/xalwart.base
      - name: Build the Library
        run: |
          sudo docker run -i \
                          -v ${{ github.workspace }}:/app \
                          xalwart/${{ matrix.compiler }}:${{ matrix.compiler_version }}-${{ matrix.os.name }}-${{ matrix.os.version }} \
                          bash /app/scripts/linux/build.sh ${{ matrix.os.name }} ${{ matrix.compiler }} ${{ matrix.compiler_version }}
      - name: Upload the Artifact
        uses: actions/upload-artifact@v2
        with:
          name: xalwart.render-${{ matrix.os.name }}-${{ matrix.compiler }}-${{ matrix.compiler_version }}
          path: xalwart.render-${{ matrix.os.name }}-${{ matrix.compiler }}-${{ matrix.compiler_version }}
          retention-days: 90
